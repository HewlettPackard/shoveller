#
# Shoveller - scalable, memory-capacity efficient key-value store for very large scale machines
#
# (c) 2017 Hewlett Packard Enterprise Development LP.
#
# This program is free software: you can redistribute it and/or modify it under the terms of the 
# GNU Lesser General Public License as published by the Free Software Foundation, either version 3 
# of the License, or (at your option) any later version. This program is distributed in the hope that 
# it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or 
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along with this program.
# If not, see <http://www.gnu.org/licenses/>. As an exception, the copyright holders of this Library 
# grant you permission to (i) compile an Application with the Library, and (ii) distribute the Application 
# containing code generated by the Library and added to the Application during this compilation process 
# under terms of your choice, provided you also meet the terms and conditions of the Application license.
#
CC := gcc
CFLAGS := -Wall -Wextra -pthread -std=gnu11
CFLAGS += -Ofast
CFLAGS += -floop-optimize -funroll-loops
CFLAGS += -ggdb
LDFLAGS := 
# rustc told me to link against these for libffi.a
LIBS := -lutil -ldl -lpthread -lgcc_s -lc -lm -lrt -lutil -lnuma

all:	shuffle

util.o:	util.c Makefile
	$(CC) $< -o $@ $(CFLAGS) -c

shuffle.o:	shuffle.c Makefile cqueue.h
	$(CC) $< -o $@ $(CFLAGS) -c

# force rebuild each time
.PHONY: shuffle
shuffle:	libffi.a shuffle.o util.o
	cargo build --lib --release
	$(CC) shuffle.o util.o -o $@ -L./ -lffi $(LDFLAGS) $(LIBS)

../../target/release/libkvs.rlib: Makefile
	cargo build --lib --release

# this was non-trivial to figure out :(
.PHONY: libffi.a
libffi.a:	ffi.rs ../../target/release/libkvs.rlib
	cargo build --lib --release
	rustc -O --crate-type=staticlib \
		--extern kvs=../../target/release/libkvs.rlib \
		-L dependency=../../target/release/deps \
		--extern log=../../target/release/deps/liblog-bf16bb9a4912b11d.rlib \
		ffi.rs

clean:
	rm -f *.o shuffle libffi.a
